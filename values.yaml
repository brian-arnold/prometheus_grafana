prometheus:
  prometheusSpec:
    nodeSelector:
      kubernetes.io/hostname: at-compute010
    retention: 21d
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: prometheus-storage 
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi
    
    additionalScrapeConfigs:
      # directPV
      - job_name: 'directpv-metrics'
        scheme: http
        metrics_path: /directpv/metrics
        authorization:
          credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        kubernetes_sd_configs:
        - role: pod

        relabel_configs:
        - source_labels: [__meta_kubernetes_namespace]
          regex: "directpv"
          action: keep
        - source_labels: [__meta_kubernetes_pod_controller_kind]
          regex: "DaemonSet"
          action: keep
        - source_labels: [__meta_kubernetes_pod_container_port_name]
          regex: "healthz"
          action: drop
          target_label: kubernetes_port_name

      - job_name: 'kubernetes-cadvisor'
        scheme: https
        metrics_path: /metrics/cadvisor
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        authorization:
          credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        kubernetes_sd_configs:
        - role: node

        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - source_labels: [__meta_kubernetes_namespace]
          action: replace
          target_label: kubernetes_namespace
        - source_labels: [__meta_kubernetes_service_name]
          action: replace
          target_label: kubernetes_name

    # this worked
    # additionalScrapeConfigs:
    #   - job_name: 'directpv-metrics'
    #     scheme: http  # Confirmed HTTP works
    #     metrics_path: /directpv/metrics
    #     kubernetes_sd_configs:
    #     - role: pod
    #       namespaces:
    #         names:
    #         - directpv
    #     relabel_configs:
    #     # Keep only node-server pods (they have the metrics port)
    #     - source_labels: [__meta_kubernetes_pod_name]
    #       regex: "node-server-.*"
    #       action: keep
    #     # Set the correct port (10443)
    #     - source_labels: [__address__]
    #       regex: '([^:]+)(?::\d+)?'
    #       target_label: __address__
    #       replacement: '${1}:10443'
    #     # Add node name as label
    #     - source_labels: [__meta_kubernetes_pod_node_name]
    #       target_label: node

  # add additional serive monitor to allow prometheus to scrape metrics from nvidia-dcgm-exporter
  additionalServiceMonitors:
    - name: nvidia-dcgm-exporter
      selector:
        matchLabels:
          app: nvidia-dcgm-exporter  # Adjust this to match your service's labels
      namespaceSelector:
        matchNames:
          - gpu-operator
      endpoints:
        - port: gpu-metrics
          interval: 15s

grafana:
  sidecar:
    dashboards:
      annotations:
        grafana_folder: "Defaults"  # Dashboards with this annotation will be put in this folder
      folderAnnotation: "grafana_folder" # custom dashboards can be organized by using the grafana_folder label in your configmap.
      provider:
       foldersFromFilesStructure: true
    alerts:
      enabled: true
      label: grafana_alert
      labelValue: "1"
      searchNamespace: ALL
  # Disable init container that sets ownership - conflicts with existing hostPath data
  initChownData:
    enabled: false
  nodeSelector:
    kubernetes.io/hostname: at-compute010
  persistence:
    enabled: true
    storageClassName: grafana-storage
    size: 2Gi
  # added to allow embedding Grafana panels in Ray Dashboard 
  grafana.ini:
    security:
      allow_embedding: true
      admin_user: admin  
    auth.anonymous:
      enabled: true
      org_role: Viewer