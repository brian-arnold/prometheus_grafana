apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: awesome-prometheus-alerts-node-exporter
  namespace: monitoring
  labels:
    release: prometheus
spec:
  groups:
  - name: node-exporter.network-saturation
    rules:
    - alert: HostUnusualNetworkThroughputIn
      annotations:
        description: >-
          Host {{ $labels.nodename }} interface {{ $labels.device }} receive bandwidth
          is at {{ $value | humanizePercentage }} of link speed.
        summary: Host network receive bandwidth saturation on {{ $labels.nodename }}
      expr: >-
        (
          (rate(node_network_receive_bytes_total[5m]) / node_network_speed_bytes) > 0.90
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 5m
      labels:
        severity: warning
    - alert: HostUnusualNetworkThroughputOut
      annotations:
        description: >-
          Host {{ $labels.nodename }} interface {{ $labels.device }} transmit bandwidth
          is at {{ $value | humanizePercentage }} of link speed.
        summary: Host network transmit bandwidth saturation on {{ $labels.nodename }}
      expr: >-
        (
          (rate(node_network_transmit_bytes_total[5m]) / node_network_speed_bytes) > 0.90
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 5m
      labels:
        severity: warning
  - name: node-exporter.disk-latency
    rules:
    - alert: HostUnusualDiskReadLatency
      annotations:
        description: >-
          Disk {{ $labels.device }} on {{ $labels.nodename }} has read latency of
          {{ printf "%.0f" $value }}ms per operation.
        summary: High disk read latency on {{ $labels.nodename }}
      expr: >-
        (
          rate(node_disk_read_time_seconds_total[1m])
          / rate(node_disk_reads_completed_total[1m]) * 1000 > 100
          and rate(node_disk_reads_completed_total[1m]) > 0
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 2m
      labels:
        severity: warning
    - alert: HostUnusualDiskWriteLatency
      annotations:
        description: >-
          Disk {{ $labels.device }} on {{ $labels.nodename }} has write latency of
          {{ printf "%.0f" $value }}ms per operation.
        summary: High disk write latency on {{ $labels.nodename }}
      expr: >-
        (
          rate(node_disk_write_time_seconds_total[1m])
          / rate(node_disk_writes_completed_total[1m]) * 1000 > 100
          and rate(node_disk_writes_completed_total[1m]) > 0
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 2m
      labels:
        severity: warning
  - name: node-exporter.filesystem-errors
    rules:
    - alert: HostFilesystemDeviceError
      annotations:
        description: >-
          Filesystem device error on {{ $labels.mountpoint }} at {{ $labels.nodename }}.
          The device backing this mount may be failing.
        summary: Filesystem device error on {{ $labels.nodename }}
      expr: >-
        (
          node_filesystem_device_error{fstype!~"^(fuse.*|tmpfs|cifs|nfs)", mountpoint!~"/mnt/md0/kubelet/.*"} == 1
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 2m
      labels:
        severity: critical
  - name: node-exporter.hardware
    rules:
    - alert: HostPhysicalComponentTooHot
      annotations:
        description: >-
          Hardware sensor {{ $labels.chip }}/{{ $labels.sensor }} on {{ $labels.nodename }}
          reports {{ printf "%.1f" $value }}Â°C, exceeding max threshold.
        summary: Physical component too hot on {{ $labels.nodename }}
      expr: >-
        (
        node_hwmon_temp_celsius > node_hwmon_temp_max_celsius
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 5m
      labels:
        severity: warning
    - alert: HostNodeOvertemperatureAlarm
      annotations:
        description: >-
          Critical temperature alarm triggered on {{ $labels.nodename }}.
          Hardware sensor {{ $labels.chip }}/{{ $labels.sensor }} has triggered
          a critical thermal alarm.
        summary: Node overtemperature alarm on {{ $labels.nodename }}
      expr: >-
        (
        node_hwmon_temp_crit_alarm_celsius == 1
        ) * on(instance) group_left(nodename) node_uname_info
        or
        (
        node_hwmon_temp_alarm == 1
        ) * on(instance) group_left(nodename) node_uname_info
      for: 0m
      labels:
        severity: critical
    - alert: HostEdacCorrectableErrorsDetected
      annotations:
        description: >-
          Host {{ $labels.nodename }} has had {{ printf "%.0f" $value }} correctable
          ECC memory errors reported by EDAC in the last minute.
        summary: EDAC correctable memory errors on {{ $labels.nodename }}
      expr: >-
        (
        increase(node_edac_correctable_errors_total[1m]) > 0
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 0m
      labels:
        severity: warning
    - alert: HostEdacUncorrectableErrorsDetected
      annotations:
        description: >-
          Host {{ $labels.nodename }} has had {{ printf "%.0f" $value }} uncorrectable
          ECC memory errors reported by EDAC. This may indicate failing DIMMs and
          risk of data corruption.
        summary: EDAC uncorrectable memory errors on {{ $labels.nodename }}
      expr: >-
        (
        node_edac_uncorrectable_errors_total > 0
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 0m
      labels:
        severity: critical
  - name: node-exporter.memory-oom
    rules:
    - alert: HostOomKillDetected
      annotations:
        description: >-
          OOM kill detected on {{ $labels.nodename }} in the last 30 minutes.
          A process was terminated by the kernel due to memory exhaustion.
        summary: OOM kill detected on {{ $labels.nodename }}
      expr: >-
        (
        increase(node_vmstat_oom_kill[30m]) > 0
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 0m
      labels:
        severity: warning
  - name: node-exporter.cpu-iowait
    rules:
    - alert: HostCpuHighIowait
      annotations:
        description: >-
          CPU iowait on {{ $labels.nodename }} is at {{ $value | humanizePercentage }}.
          The CPU is spending significant time waiting on storage I/O.
        summary: High CPU iowait on {{ $labels.nodename }}
      expr: >-
        (
        avg without (cpu) (rate(node_cpu_seconds_total{mode="iowait"}[5m])) > 0.10
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 5m
      labels:
        severity: warning
  - name: node-exporter.capacity-planning
    rules:
    - alert: HostMemoryIsUnderutilized
      annotations:
        description: >-
          Node {{ $labels.nodename }} memory usage has been < 20% for 1 week.
          Consider reducing memory allocation or consolidating workloads.
        summary: Host memory underutilized on {{ $labels.nodename }}
      expr: >-
        (
        min_over_time(node_memory_MemFree_bytes[1w]) > node_memory_MemTotal_bytes * 0.8
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 0m
      labels:
        severity: info
    - alert: HostCpuIsUnderutilized
      annotations:
        description: >-
          Node {{ $labels.nodename }} CPU usage has been < 20% for 1 week.
          Consider reducing CPU allocation or consolidating workloads.
        summary: Host CPU underutilized on {{ $labels.nodename }}
      expr: >-
        (
          (min without (cpu) (rate(node_cpu_seconds_total{mode="idle"}[1h]))) > 0.8
        )
        * on(instance) group_left(nodename) node_uname_info
      for: 1w
      labels:
        severity: info
  - name: node-exporter.kernel
    rules:
    - alert: HostKernelVersionDeviations
      annotations:
        description: >-
          Kernel version on {{ $labels.nodename }} has changed.
          Current: {{ $labels.release }}.
        summary: Kernel version changed on {{ $labels.nodename }}
      expr: >-
        changes(node_uname_info[1h]) > 0
      for: 0m
      labels:
        severity: info